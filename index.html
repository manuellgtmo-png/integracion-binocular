<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integraci√≥n Binocular Cl√≠nica v10</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;900&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-dark: #0a0f1d; --accent-pink: #ff2e63; --accent-blue: #08d9d6;
            --rojo-fondo: #80322a; --rojo-figura: #69302a;
            --verde-fondo: #69913d; --verde-figura: #6c7b5a;
        }
        body { margin: 0; font-family: 'Montserrat', sans-serif; background: var(--bg-dark); color: white; overflow: hidden; height: 100vh; }
        
        /* Barra Profesional Independiente */
        #admin-bar { display: none; background: var(--accent-blue); color: #0a0f1d; padding: 10px 20px; justify-content: space-between; align-items: center; font-weight: bold; font-size: 0.9rem; z-index: 3000; position: relative; }
        .btn-view { background: #0a0f1d; color: white; border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        .overlay { position: fixed; inset: 0; background: rgba(10, 15, 29, 0.98); z-index: 2000; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .card { background: white; color: #2d3436; border-radius: 40px; padding: 35px; width: 95%; max-width: 450px; text-align: center; box-shadow: 0 15px 0 var(--accent-blue); position: relative; }
        
        .btn { background: var(--accent-pink); color: white; padding: 18px; border-radius: 20px; font-weight: 900; border: none; cursor: pointer; width: 100%; font-size: 1.2rem; margin-top: 15px; text-transform: uppercase; box-shadow: 0 8px 0 #b31d45; transition: 0.2s; }
        .btn-next { background: #00ff88; color: #003311; box-shadow: 0 8px 0 #009955; font-size: 1.5rem; animation: pulse 1.5s infinite; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        .header { height: 70px; background: #1a1a2e; display: flex; justify-content: space-around; align-items: center; border-bottom: 5px solid var(--accent-pink); }
        .stat b { display: block; color: var(--accent-blue); font-size: 0.7rem; }
        
        #game-container { display: flex; height: calc(100vh - 110px); }
        .lado { width: 50%; height: 100%; position: relative; overflow: hidden; }
        #lado-rojo { background: var(--rojo-fondo); }
        #lado-verde { background: var(--verde-fondo); }
        
        .figura { position: absolute; font-weight: 900; user-select: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        #indicador { position: absolute; top: 125px; left: 50%; transform: translateX(-50%); background: white; color: black; padding: 6px 25px; border-radius: 50px; font-weight: 900; z-index: 1000; border: 3px solid var(--accent-pink); }
        
        input { width: 100%; padding: 15px; border-radius: 15px; border: 3px solid #eee; margin-top: 10px; text-align: center; font-weight: bold; box-sizing: border-box; font-size: 1rem; }
        #flash { position: fixed; inset: 0; background: rgba(255, 46, 99, 0.4); pointer-events: none; opacity: 0; z-index: 4000; }
        @keyframes errorFlash { 0% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body>

<div id="flash"></div>

<div id="admin-bar">
    <span>MODO PROFESIONAL ACTIVO</span>
    <button class="btn-view" onclick="window.open('https://docs.google.com/spreadsheets/d/1Tm068QA9fWLAmnrqYgIqDdcl211OZkyIpcd0/edit', '_blank')">üîç BUSCAR PACIENTE EN EXCEL</button>
</div>

<div id="screen-start" class="overlay">
    <div class="card">
        <button style="position:absolute; top:20px; right:20px; background:none; border:none; cursor:pointer; opacity:0.3;" onclick="unlockAdmin()">‚öôÔ∏è</button>
        <h1 style="color:var(--accent-pink); margin:0;">BIENVENIDO</h1>
        <input type="text" id="paciente" placeholder="Nombre del Paciente">
        <input type="text" id="profesional" placeholder="Profesional a cargo">
        <button class="btn" onclick="showIntro()">SIGUIENTE</button>
    </div>
</div>

<div id="screen-intro" class="overlay" style="display:none">
    <div class="card">
        <h2 style="color:var(--accent-pink);">¬øC√≥mo jugar?</h2>
        <div style="text-align:left; color:#2d3436; font-size: 0.9rem; line-height: 1.5;">
            <p>üï∂Ô∏è <b>Paso 1:</b> Col√≥cate tus gafas <b>Rojo/Verde</b>.</p>
            <p>üîç <b>Paso 2:</b> Mira la letra que aparece en el centro arriba.</p>
            <p>üëÜ <b>Paso 3:</b> Toca <u>solo</u> esa letra en el lado rojo o verde.</p>
            <p>‚ö†Ô∏è <b>Paso 4:</b> Tienes 2 vidas. ¬°No toques el fondo!</p>
        </div>
        <button class="btn" onclick="showSkills()">ENTENDIDO</button>
    </div>
</div>

<div id="screen-skills" class="overlay" style="display:none">
    <div class="card" style="background:#16213e; color:white;">
        <h2 style="color:var(--accent-blue);">‚ú® Habilidades a trabajar:</h2>
        <div style="text-align:left; margin: 20px 0; font-size: 0.9rem; line-height: 1.6;">
            <p>üëÅÔ∏è <b>Antisupresi√≥n:</b> Estimula el ojo vago.</p>
            <p>üéØ <b>Fusi√≥n Plana:</b> Integra ambas im√°genes.</p>
            <p>üöÄ <b>Coordinaci√≥n:</b> Ojo-mano en tiempo real.</p>
        </div>
        <button class="btn" onclick="startGame()">¬°EMPEZAR!</button>
    </div>
</div>

<div id="screen-next" class="overlay" style="display:none">
    <div class="card">
        <h1 style="color:#009955; margin:0;">¬°BIEN HECHO!</h1>
        <p>Has superado el nivel con √©xito.</p>
        <button class="btn btn-next" onclick="iniciarNivel()">SIGUIENTE NIVEL ‚ûî</button>
    </div>
</div>

<div id="screen-end" class="overlay" style="display:none">
    <div class="card">
        <h1 style="color:var(--accent-pink); margin:0;">SESI√ìN FINALIZADA</h1>
        <div id="status-envio" style="margin:20px 0; font-weight:bold; color:#009955;">üì§ Sincronizando datos...</div>
        <p id="resumen-final" style="font-size:0.9rem; color:#636e72;"></p>
        <button class="btn" style="background:#636e72; box-shadow:0 8px 0 #2d3436;" onclick="finalForceReload()">SALIR AL INICIO</button>
    </div>
</div>

<div class="header">
    <div class="stat"><b>NIVEL</b><span id="txt-nivel">1</span></div>
    <div class="stat"><b>ACIERTOS</b><span id="txt-ok">0</span></div>
    <div class="stat"><b>VIDAS</b><span id="txt-vidas" style="color:var(--accent-pink)">2</span></div>
    <div class="stat"><b>TIEMPO</b><span id="txt-timer">0.0s</span></div>
</div>

<div id="indicador">BUSCA: <span id="target-obj" style="color:var(--accent-pink)">-</span></div>

<div id="game-container">
    <div id="lado-rojo" class="lado" onclick="failClick()"></div>
    <div id="lado-verde" class="lado" onclick="failClick()"></div>
</div>

<script>
    let nivel = 1, totalAciertos = 0, vidas = 2, fallos = 0;
    let jugando = false, sessionStartTime, objActual = "";
    let elementos = [];
    const formas = ["‚óè", "‚ñ†", "‚ñ≤", "E", "H", "O", "X", "U", "V"];

    function unlockAdmin() {
        if(prompt("Clave Profesional:") === "1234") document.getElementById('admin-bar').style.display = 'flex';
    }

    function showIntro() {
        if(!document.getElementById('paciente').value || !document.getElementById('profesional').value) return alert("Ingresa los nombres.");
        document.getElementById('screen-start').style.display = 'none';
        document.getElementById('screen-intro').style.display = 'flex';
    }

    function showSkills() {
        document.getElementById('screen-intro').style.display = 'none';
        document.getElementById('screen-skills').style.display = 'flex';
    }

    function startGame() {
        document.getElementById('screen-skills').style.display = 'none';
        sessionStartTime = Date.now();
        iniciarNivel();
    }

    function iniciarNivel() {
        document.getElementById('screen-next').style.display = 'none';
        jugando = true; vidas = 2;
        document.getElementById('txt-vidas').innerText = vidas;
        document.getElementById('txt-nivel').innerText = nivel;
        objActual = formas[Math.floor(Math.random() * formas.length)];
        document.getElementById('target-obj').innerText = objActual;
        generarObjetos();
        requestAnimationFrame(update);
    }

    function generarObjetos() {
        document.getElementById('lado-rojo').innerHTML = "";
        document.getElementById('lado-verde').innerHTML = "";
        elementos = [];
        const cant = 2 + nivel;
        for(let i=0; i<cant; i++) { crear(true, 'rojo'); crear(true, 'verde'); }
        for(let i=0; i<nivel*3; i++) { crear(false, 'rojo'); crear(false, 'verde'); }
    }

    function crear(esObj, lado) {
        const div = document.createElement('div');
        div.className = "figura";
        div.innerText = esObj ? objActual : formas.filter(f => f !== objActual)[Math.floor(Math.random()*5)];
        const size = (Math.max(35, 140 - (nivel * 6))) * (Math.random() * 0.7 + 0.6);
        div.style.fontSize = size + 'px';
        div.style.color = lado === 'rojo' ? 'var(--rojo-figura)' : 'var(--verde-figura)';
        const el = { dom: div, x: Math.random()*(window.innerWidth/2-80), y: Math.random()*(window.innerHeight-250), 
                     vx: (Math.random()-0.5)*(1.5+nivel*0.3), vy: (Math.random()-0.5)*(1.5+nivel*0.3), size, esObj };
        div.onclick = (e) => {
            e.stopPropagation();
            if(esObj) { 
                div.remove(); elementos = elementos.filter(i => i !== el); totalAciertos++;
                document.getElementById('txt-ok').innerText = totalAciertos;
                if(elementos.filter(e => e.esObj).length === 0) passLevel();
            } else failClick();
        };
        document.getElementById(`lado-${lado}`).appendChild(div);
        elementos.push(el);
    }

    function update() {
        if(!jugando) return;
        const w = window.innerWidth/2, h = window.innerHeight-100;
        elementos.forEach(el => {
            el.x += el.vx; el.y += el.vy;
            if(el.x < 0 || el.x > w - el.size) el.vx *= -1;
            if(el.y < 0 || el.y > h - el.size) el.vy *= -1;
            el.dom.style.transform = `translate(${el.x}px, ${el.y}px)`;
        });
        document.getElementById('txt-timer').innerText = ((Date.now()-sessionStartTime)/1000).toFixed(1) + "s";
        requestAnimationFrame(update);
    }

    function failClick() {
        if(!jugando) return;
        vidas--; fallos++;
        document.getElementById('flash').style.animation = "none"; document.getElementById('flash').offsetHeight; 
        document.getElementById('flash').style.animation = "errorFlash 0.4s";
        document.getElementById('txt-vidas').innerText = vidas;
        if(vidas <= 0) { 
            jugando = false;
            document.getElementById('resumen-final').innerText = `Resultados finales guardados para ${document.getElementById('paciente').value}.`;
            document.getElementById('screen-end').style.display = 'flex';
            enviarAutomatico();
        }
    }

    function passLevel() { jugando = false; nivel++; document.getElementById('screen-next').style.display = 'flex'; }

    function enviarAutomatico() {
        // IMPORTANTE: Verifica que estos IDs correspondan a las columnas de tu Excel
        const url = "https://docs.google.com/forms/d/e/1FAIpQLSeLlcvlhrTSHDhvxctLghiM3caGsgBL2wdaT7nBxrz6UARwYg/formResponse";
        const fd = new FormData();
        fd.append("entry.369874016", document.getElementById('paciente').value);
        fd.append("entry.1353470174", "Integraci√≥n Binocular (Prof: " + document.getElementById('profesional').value + ")");
        fd.append("entry.721051298", nivel);
        fd.append("entry.873272199", totalAciertos);
        fd.append("entry.1030094511", fallos);
        fd.append("entry.1303309812", document.getElementById('txt-timer').innerText);
        fd.append("entry.845098414", new Date().toLocaleDateString());

        fetch(url, { method: "POST", mode: "no-cors", body: fd })
        .then(() => {
            document.getElementById('status-envio').innerHTML = "‚úÖ DATOS ENVIADOS AL EXCEL";
        })
        .catch(() => {
            document.getElementById('status-envio').innerHTML = "‚ö†Ô∏è Reintentando conexi√≥n...";
        });
    }

    function finalForceReload() {
        enviarAutomatico(); // √öltimo intento de respaldo
        setTimeout(() => { location.reload(); }, 800);
    }
</script>
</body>
</html>




